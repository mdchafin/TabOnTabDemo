@page "/tabdemo"
@rendermode InteractiveServer
@using TabOnTabDemo.Models
@using TabOnTabDemo.Services
@inject TabStateService TabStateService

<PageTitle>Tab Demo</PageTitle>

<h3>Parent Tab - Seed Records (Max 5)</h3>

<div class="tabs">
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @GetActiveClass("seed")"
                    @onclick="@(() => SwitchParentTab("seed"))"
                    type="button">
                Seed Records
            </button>
        </li>
        @foreach (var childTab in childTabs)
        {
            <li class="nav-item" role="presentation">
                <button class="nav-link @GetActiveClass(childTab.TabId)"
                        @onclick="@(() => SwitchParentTab(childTab.TabId))"
                        type="button">
                    @childTab.Name
                    <span class="badge bg-secondary ms-1" 
                          @onclick:stopPropagation="true" 
                          @onclick="@(() => CloseTab(childTab.TabId))"
                          style="cursor: pointer;">×</span>
                </button>
            </li>
        }
    </ul>

    <div class="tab-content border border-top-0 p-3">
        @if (activeParentTab == "seed")
        {
            <div class="row">
                @foreach (var record in seedRecords)
                {
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5>@record.Person.Name</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Email:</strong> @record.Person.Email</p>
                                <p><strong>Phone:</strong> @record.Person.Phone</p>
                                <hr />
                                <h6>Available Items:</h6>
                                <ul class="list-group">
                                    @foreach (var item in record.Items)
                                    {
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>@item.Name</strong>
                                                <br />
                                                <small>@item.Description</small>
                                            </div>
                                            <button class="btn btn-sm btn-primary" @onclick="@(() => OpenItemInNewTab(item))">
                                                Open
                                            </button>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <ChildTab TabId="@activeParentTab" />
        }
    </div>
</div>

@code {
    private string activeParentTab = "seed";
    private List<SeedRecord> seedRecords = new();
    private List<(string TabId, string Name)> childTabs = new();

    protected override void OnInitialized()
    {
        InitializeSeedRecords();
    }

    private void InitializeSeedRecords()
    {
        seedRecords = new List<SeedRecord>
        {
            new SeedRecord
            {
                Id = 1,
                Person = new Person { Id = 1, Name = "John Doe", Email = "john@example.com", Phone = "555-0101" },
                Items = new List<RecordItem>
                {
                    new RecordItem { Id = 1, Name = "Profile Data", Description = "User profile information", Data = "Profile details for John Doe" },
                    new RecordItem { Id = 2, Name = "Settings", Description = "User settings", Data = "Settings data for John" }
                }
            },
            new SeedRecord
            {
                Id = 2,
                Person = new Person { Id = 2, Name = "Jane Smith", Email = "jane@example.com", Phone = "555-0102" },
                Items = new List<RecordItem>
                {
                    new RecordItem { Id = 3, Name = "Dashboard", Description = "Dashboard configuration", Data = "Dashboard config for Jane Smith" },
                    new RecordItem { Id = 4, Name = "Reports", Description = "Report templates", Data = "Report templates for Jane" }
                }
            },
            new SeedRecord
            {
                Id = 3,
                Person = new Person { Id = 3, Name = "Bob Johnson", Email = "bob@example.com", Phone = "555-0103" },
                Items = new List<RecordItem>
                {
                    new RecordItem { Id = 5, Name = "Preferences", Description = "User preferences", Data = "Preferences for Bob Johnson" }
                }
            },
            new SeedRecord
            {
                Id = 4,
                Person = new Person { Id = 4, Name = "Alice Williams", Email = "alice@example.com", Phone = "555-0104" },
                Items = new List<RecordItem>
                {
                    new RecordItem { Id = 6, Name = "History", Description = "Activity history", Data = "Activity history for Alice Williams" },
                    new RecordItem { Id = 7, Name = "Analytics", Description = "Analytics data", Data = "Analytics for Alice" }
                }
            },
            new SeedRecord
            {
                Id = 5,
                Person = new Person { Id = 5, Name = "Charlie Brown", Email = "charlie@example.com", Phone = "555-0105" },
                Items = new List<RecordItem>
                {
                    new RecordItem { Id = 8, Name = "Documents", Description = "Document management", Data = "Documents for Charlie Brown" }
                }
            }
        };
    }

    private string GetActiveClass(string tabId)
    {
        return activeParentTab == tabId ? "active" : "";
    }

    private void OpenItemInNewTab(RecordItem item)
    {
        var tabId = $"tab-{item.Id}";
        
        if (!childTabs.Any(t => t.TabId == tabId))
        {
            childTabs.Add((tabId, item.Name));
            TabStateService.GetOrCreateTabState(tabId, item);
        }
        
        activeParentTab = tabId;
    }

    private void SwitchParentTab(string tabId)
    {
        activeParentTab = tabId;
    }

    private void CloseTab(string tabId)
    {
        childTabs.RemoveAll(t => t.TabId == tabId);
        TabStateService.RemoveTabState(tabId);
        
        if (activeParentTab == tabId)
        {
            activeParentTab = "seed";
        }
    }
}
